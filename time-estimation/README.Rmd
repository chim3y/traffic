---
title: "Estimation of time-spent on AUSA toll booths"
author: "Julián Ailán"
params:
  date: "!r Sys.Date()"
output:
  md_document:
    toc: yes
    variant: markdown_github
---

```{r setupandrequiredpackages, include=FALSE, fig.align="center"}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls()); gc();

packages.to.include <- c('dplyr', 'tibble', 'ggplot2', 'ff', 'reshape2')
lapply(packages.to.include, require, character.only = T)

rm(packages.to.include)
```

### Objective
This project consists on estimating time-spent by drivers on AUSA toll booths in Buenos Aires highways. Currently users of these highways experience excessive amount of time waiting to go through toll booths on peak hours. In addition to estimating this metric, an analysis of whether contextual variables like toll-booth fee or oil prices have an impact on the behavior and amount of users commuting through these highways.

### Joining the traffic dataset with the oil dataset
The `traffic.csv` dataset previously analized [here](https://github.com/tulians/traffic/tree/master/descriptive) has a file size of approximately 562MB, while the `oil_prices.csv` dataset is only 11.2KB. We'll be merging both files in an inner join fashion, using the year and month columns via the [`merge()`](https://www.rdocumentation.org/packages/base/versions/3.6.0/topics/merge) function. As a result of this merge each existing row in `traffic.csv` will be repeated 4 times, one per each oil type, thus taking the final, merged, dataset to an approximate size of 2.2GB.

R requires that variables are stored in RAM in its entirety, so managing a dataframe this big could be imposible for some machines if no alternate processing is performed. For this reason is that the [`ff`](https://cran.r-project.org/web/packages/ff/index.html) package will be used.

```{r readingunifiedfile, echo=FALSE}
# Directory where `ff` stores temporary files.
options(fftempdir = '~/Documents/traffic/datasets/tmp')
unified.ff <- read.csv.ffdf(file = '~/Documents/traffic/datasets/unified.csv')
```

### Analysis of oil price behavior
The oil prices dataset consists of monthly prices of different types of oil: super, premium, gasoil, and euro. The four of them experienced a steady increase since 2008 until 2018, which is illustrated in Figure 1.

```{r pricethroughtime, echo=FALSE}
oil_price <- unified.ff %>% as_tibble() %>%
  group_by(Y, oil.type) %>%
  summarise(price = max(price))

ggplot(data = oil_price, aes(x = Y, y = price, group = oil.type)) +
  geom_line(aes(color = oil.type)) +
  geom_point(alpha = 1/5) +
  labs(x = NULL, y = 'ARS ($)',
       title = 'Price of oil through time', caption = 'Figure 1') +
  theme_minimal()

rm(oil_price)
```

```{r correlations, echo=FALSE}
ff.df <- unified.ff %>% as_tibble() %>%
  select(Y, M, amount, price) %>%
  filter(Y >= 2014) %>%
  group_by(Y, M) %>%
  summarise(
    price = mean(price),
    vehicles = sum(amount)
  )

pv.correlation <- cor(ff.df$price, ff.df$vehicles)
```

Building on top of the previous analysis of traffic patterns performed [here](https://github.com/tulians/traffic/blob/master/descriptive/README.md), it would be intersting to analyze whether there was a correlation between the rate at which the number of vehicles passing through toll booths [started to grow month-over-month](https://github.com/tulians/traffic/blob/master/descriptive/README_files/figure-markdown_github/trend-1.png), and the month-over-month (M-o-M) increase in oil prices depicted in Figure 1. As seen in Figure 2 (condidering only information from January 2014 onwards, after the [unexpected growth](https://github.com/tulians/traffic/tree/master/descriptive#increment-in-traffic)) there is barely a linear relation between these two differences, which is represented by the Pearson correlation coefficient of `r pv.correlation`. This correlation, even though it's not strong, it's positive, which implies that an increase in oil prices does not necessarily result in a decrease in traffic volume, but rather the opposite in this case.

```{r correlationgraph, echo=FALSE}
ggplot(data = ff.df, aes(x = price, y = vehicles)) +
  geom_point(alpha = 2/5) +
  geom_smooth(method = 'lm') +
  labs(x = 'Oil price (ARS)', 
       y = 'Volume of vehicles',
       title = 'Relation of oil price and amount of vehicles', 
       caption = 'Figure 2') +
  theme_minimal()
```

```{r differences, echo=FALSE}
ff.df.differences <- data.frame(
  Y = diff(ff.df$Y),
  M = diff(ff.df$M),
  price = diff(ff.df$price / max(ff.df$price)),
  vehicles = diff(ff.df$vehicles / max(ff.df$vehicles))
)

ff.df.differences$vehicles[which.min(ff.df.differences$vehicles)] <- 
  mean(ff.df.differences$vehicles)
ff.df.differences$vehicles[which.max(ff.df.differences$vehicles)] <- 
  mean(ff.df.differences$vehicles)

# Move from wide to tall format to plot multiple series in the same graph.
ff.df.tall <- melt(
  ff.df.differences, 
  id.vars = c('Y', 'M'),
  measure.vars = c('price', 'vehicles'),
  variable.name = 'series',
  value.name = 'measurement') %>%
  select(series, measurement) %>%
  group_by(series) %>%
  mutate(id = row_number())

diff.correlation <- cor(ff.df.differences$price, ff.df.differences$vehicles)
```

A more interesting approach in the search for a relation between vehicle volume and oil price would be to look at the M-o-M differences of each time series. Figure 3 shows the behavior through time of the difference of each of the variables, which was computed over the normalized series. Again, computing the correlation between both differences yields a positive number, `r diff.correlation`, which shows non-conclusive evidence that an increase in oil price could impact the volume of vehicles passing through toll booths (at least not in a month by month basis).

```{r differencesgraph, echo=FALSE}
ggplot(data = ff.df.tall, 
       aes(x = id, y = measurement, group = series, colour = series)) +
  geom_line() +
  labs(x = 'index', 
       y = 'Delta (M_i - M_{i-1})',
       title = 'M-o-M differences for both amount of vehicles and oil prices', 
       caption = 'Figure 3') +
  theme_minimal()

rm(ff.df.differences, ff.df.tall)
```